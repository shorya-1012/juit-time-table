#!/usr/bin/env python3

import argparse
import json
import re
import requests
import pandas as pd
from io import BytesIO

parser = argparse.ArgumentParser(description="Generate timetable JSON from XLS")
parser.add_argument("-t", "--timetable-url", required=True, type=str, help="Public url for xls file")
parser.add_argument("-d", "--debug", action="store_true", help="Enable verbose logging")
args = parser.parse_args()

def clean_sheet_name(name: str) -> str:
    name = name.strip()
    name = re.sub(r"\s+", " ", name)
    name = name.replace(" ", "")
    return f"{name}.json"

DAY_ROW = {0: (3, 18), 1: (19, 34), 2: (35, 50), 3: (51, 66), 4: (67, 82), 5: (83, 98)}

if args.debug:
    print("Downloading XLS file...")

response = requests.get(args.timetable_url, timeout=30)
response.raise_for_status()

xls = pd.ExcelFile(BytesIO(response.content), engine="xlrd")
sheet_names = xls.sheet_names

if args.debug:
    print("Sheets found:", sheet_names)

# skip first sheet (teachers timetable)
target_sheets = sheet_names[1:]

dfs = pd.read_excel(xls, sheet_name=target_sheets)

for sheet_name, df in dfs.items():
    if args.debug:
        print(f"Processing sheet: {sheet_name}")
        print("Shape:", df.shape)

    output = []

    for day, (start, end) in DAY_ROW.items():
        for time_col in range(1, 10):

            slot_series = df.iloc[start:end, time_col]
            data_list = slot_series.dropna().astype(str).str.strip().tolist()
            output.append({
                "day": day,
                "time": time_col,
                "data": data_list
            })

    file_name = clean_sheet_name(sheet_name)

    if args.debug:
        print(f"Writing {file_name} ({len(output)} entries)")

    with open(file_name, "w", encoding="utf-8") as f:
        json.dump(output, f, ensure_ascii=False, indent=2)
